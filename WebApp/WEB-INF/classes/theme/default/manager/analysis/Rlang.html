
<body> 
  ${navbar!""}
  <div class="main-container" id="main-container"> 
   <script type="text/javascript">
				try{ace.settings.check('main-container' , 'fixed')}catch(e){}
			</script> 
   <div class="main-container-inner"> 
    
    ${menu!""}
     <div class="main-content"> 
     <div class="breadcrumbs" id="breadcrumbs"> 
      <script type="text/javascript">
							try{ace.settings.check('breadcrumbs' , 'fixed')}catch(e){}
						</script> 
      <ul class="breadcrumb"> 
       <li> <i class="icon-home home-icon"></i> <a href="#">首页</a> </li> 
       <li class="active">${name}</li> 
      </ul> 
      <!-- #nav-search --> 
     </div> 
     <div class="page-content"> 
      <!-- /.page-header --> 
      <div class="row"> 
      	<div class="col-xs-12 ">
      	
	      	<#if error??>
			<div class="alert alert-danger">
				<button data-dismiss="alert" class="close" type="button">
					<i class="icon-remove"></i>
				</button>
				<strong> <i class="icon-remove"></i> Oh Bug!
				</strong> ${error!""}. <br />
			</div>
			</#if>
			<div class="col-xs-6">
			   	<div class="col-xs-12">				

					<div class="widget-box">
						<div class="widget-header widget-header-flat">
							<h4 class="smaller">
								<i class="icon-code"></i>
								R代码编辑器
																
							</h4>
						</div>
		
						<div class="widget-body">
							<div class="widget-main">
								<textarea id="r_query" name="r_query"  rows="20" cols="100" style="width:98%;" onkeypress="FoundVar(event)"></textarea>
							</div>
						</div>
					</div>	
				
				
				</div>
				

				
				<div class="col-xs-12">
					<h3 class="header smaller lighter blue">
						[<a href="javascript:void(0)" onclick="ScriptR()">查询</a>] <small>结果:
						</small>
					</h3>
				</div>
			  	<div class="col-xs-12">         			      
			        <h5><span id="json_result" name="json_result"></span></h5> 			       
		      	</div>		
			</div>
			<div class="col-xs-6">

				<div class="tabbable">
					<ul class="nav nav-tabs padding-12 tab-color-blue background-blue" id="myTab4">
						<li class="active">
							<a data-toggle="tab" href="#home4">保存</a>
						</li>
						<li>
							<a data-toggle="tab" href="#excel">上传文件</a>
						</li>
						<li>
							<a data-toggle="tab" href="#helps">帮助</a>
						</li>
						<li>
							<a data-toggle="tab" href="#pack">安装包</a>
						</li>

					</ul>

					<div class="tab-content">
						
								
						<div id="home4" class="tab-pane in active">
							<form id="target" name="target"  onsubmit="return validateForm()"  class="form-horizontal id-message-form" enctype="multipart/form-data"
									action='${action_url!""}' method="POST" class="form-inline">
							<textarea id="rcode" name="rcode"  rows=10" cols="10" style="display: none;" ></textarea>
							
							<h3 class="header smaller lighter blue">分类：</h3>

							<div class="form-group">


								<select id="cid_list" name="cid_list">
									
									<#if pid_list??>
						           		<#list pid_list as pitem>		
										<option value="${pitem.id?c}" <#if pitem.id?c == pid?c>  selected </#if> >${pitem.name!""}</option>
										</#list>
									</#if>	
								</select>

							</div>
							<h3 class="header smaller lighter blue">定时运行：
								<span class="help-button" title=""
								data-content="只是显示目前有多少 个mongodb规则 可用" data-html="true"
								data-placement="left" data-trigger="hover" data-rel="popover"
								data-original-title="说明">?</span>
							</h3>
							天：<input type="text" class="input-mini" id="loopday"  name="loopday" />
							小时：<input type="text" class="input-mini" id="loophour" name="loophour" />
							分：<input type="text" class="input-mini" id="loopminu"  name="loopminu" />
							
							<h3 class="header smaller lighter blue">名称：</h3>
							<input type="text" value="" placeholder="名称"  id="title" name="title">
							<h3 class="header smaller lighter blue">描述：</h3>
							<input type="text" value="" placeholder="描述"  id="rdesc" name="rdesc">
							<button type="submit" class="btn btn-sm btn-default"> <i class="icon-ok bigger-110"></i> 保存 </button>
							</form>
						</div>
						

						<div id="excel" class="tab-pane">
					
							<h3 class="header smaller lighter blue">
								<i class="icon-folder-open"></i>
								文件:
							</h3>
							<form id="target" name="target"  onsubmit="return validateForm()"  class="form-horizontal id-message-form" enctype="multipart/form-data"
									action='${action_url!""}' method="POST" class="form-inline">
							<h3 class="header smaller lighter blue">选择文件：</h3>
							<input type="file" name="attachment" id="attachment"  accept=".csv, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet, application/vnd.ms-excel" />
							<a href="javascript:void(0)" id="saveImg" name="saveImg" class="btn btn-primary"
										onclick="SaveFile()"><i  id="loop_ico" name="loop_ico"  class="icon-beaker align-top bigger-125"></i> <span id="loop_name" name="loop_name">保存图表</span></a>
							</form>
							<h3 class="header smaller lighter blue">文件列表：</h3>
								<table class="table table-striped table-bordered table-hover"
										id="sample-table-1">
									<thead>
										<tr>
											<th>id</th>
											<th>名称</th>
											<th class="hidden-480">路径</th>
											<th class="hidden-480">时间</th>
										</tr>
									</thead>
									<tbody id="sqlparams" name="sqlparams">										
									<tr>
										<td class='center'>1</td>
										<td class='center'>文件名</td>
										<td class='center'>./data/daer.xle</td>
										<td class='center'>2015-12-8</td>
									</tr>
									</tbody>
								</table>
								
						</div>
						<div id="helps" class="tab-pane">
				
							<h3 class="header smaller lighter blue">
								<i class="icon-code"></i>
								帮助:<span id="cname" name="cname"></span>
							</h3>
			
							<div class="widget-main">
								<pre class="prettyprint linenums" id="tips" name="tips"></pre>
							</div>
							
						</div>
						<div id="pack" class="tab-pane">
				
			
							<h3 class="header smaller lighter blue">已安装包列表：</h3>
								<table class="table table-striped table-bordered table-hover"
										id="sample-table-1">
									<thead>
										<tr>
											<th>id</th>
											<th>名称</th>
											<th>版本</th>
										</tr>
									</thead>
									<tbody id="packlist" name="packlist">										
									
									</tbody>
								</table>
							
						</div>

						
					</div>
				</div>
					
			</div>
			
	    </div>

       
     </div> 
     <!-- /.row --> 
    <!-- /.main-content --> 
    
   </div> 
   <!-- /.main-container-inner --> 
   <a href="#" id="btn-scroll-up" class="btn-scroll-up btn btn-sm btn-inverse"> <i class="icon-double-angle-up icon-only bigger-110"></i> </a> 
  </div> 
  <!-- /.main-container --> 
  
  <script language="Javascript" type="text/javascript" src="${static_js_uri}/textline/jquery-linedtextarea.js"></script>
    <script type="text/javascript" src="${static_js_uri}/pretty_json/underscore-min.js" ></script>
  <script type="text/javascript" src="${static_js_uri}/pretty_json/backbone-min.js" ></script>
  <script type="text/javascript" src="${static_js_uri}/pretty_json/pretty-json-min.js" ></script>
  <script type="text/javascript" src="${static_js_uri}/textcomplete/jquery.textcomplete.min.js"></script> 
  <script src="${static_js_uri}/fuelux/fuelux.spinner.min.js"></script>
  <script type="text/javascript" charset="utf-8" src="${static_js_uri}/cookie.js"></script>
  <script type="text/javascript">
  
	var RKeyWords = ${r_key_list};
  
	jQuery(function($) {
			 
		$('.id-message-form .ace-file-input').closest('.file-input-container:not(:first-child)').remove();
		$('.id-message-form input[type=file]').ace_file_input('reset_input');
	
		$('.id-message-form input[type=file]').ace_file_input()
		//and the wrap it inside .span7 for better display, perhaps
		.closest('.ace-file-input').addClass('width-90 inline').wrap('<div class="row file-input-container"><div class="col-sm-7"></div></div>');
		
		
		$('#loopday').ace_spinner({value:0,min:0,max:31,step:1, on_sides: true, icon_up:'icon-plus smaller-75', icon_down:'icon-minus smaller-75', btn_up_class:'btn-success' , btn_down_class:'btn-danger'});
		$('#loophour').ace_spinner({value:0,min:0,max:24,step:1, on_sides: true, icon_up:'icon-plus smaller-75', icon_down:'icon-minus smaller-75', btn_up_class:'btn-success' , btn_down_class:'btn-danger'});
		$('#loopminu').ace_spinner({value:0,min:0,max:60,step:5, on_sides: true, icon_up:'icon-plus smaller-75', icon_down:'icon-minus smaller-75', btn_up_class:'btn-success' , btn_down_class:'btn-danger'});
		
		var completes = [
							{							
					    	match: /\b([a-zA-Z._]{2,})$/,
					        search: function (term, callback) {
					            callback($.map(RKeyWords, function (element) {
					                return element.indexOf(term) === 0 ? element : null;
					            }));
					        },
					        template: function (value) {
					        	var val = value.substr(0, value.length-4);
					        	if(value.indexOf("_var") >= 0){					        		
					        		return '<i class="orange icon-exclamation-sign"></i>&nbsp;' + val;	
					        	}else if(value.indexOf("_fun") >= 0){
									return '<i class="purple icon-exclamation-sign"></i>&nbsp;' + val;
					        	}
					        	else{
					        		return '<i class="green icon-exclamation-sign"></i>&nbsp;' + value;
					        	}
					            
					        },
					        index: 1,
					        replace: function (element) {
					        	var val = element.substr(0, element.length-4);
					        	if(element.indexOf("_var") >= 0){
					        		return val;
					        	}else if(element.indexOf("_fun") >= 0){
					        		return [val+'(',  ')'];
					        	}
					        	else{
					        		return [element+'(',  ')'];
					        	}

					        }
					    },
					    					    
					];	
		$('#r_query').textcomplete(completes);

		$("#r_query").linedtextarea(
				{selectedLine: 1}
			);
		
		
		setTimeout(initEdits, 2000);
		
	   	setInterval("myInterval()",10000);//1000为1秒钟  60秒一次
		
	   	ListUserInstallPack();
	});
	
	
	function ListUserInstallPack(){
		
		$.ajax({
			  url: "${script_url}?jsoncallback=?",
			  contentType: 'text/html;charset=utf-8',			  
			  data:{"listPack":1},
			  success: function(result){
				  console.log("success"+result);
			  },
			  error: function(request, textStatus, errorThrown) {
			    //alert(textStatus);
			  },
			  complete: function(request, textStatus) { //for additional info
				  var option = request.responseText;
				 // option = option.replace(/[\r\n]/g, "<br />");							  
				  
				 // console.log("success:"+option);
				  var pack=[];
				  var version=[];
				  var json_res = JSON.parse(option);
				  for (var jkey in json_res) {
					  
				  	  for(var jl in json_res[jkey] ){
				  		console.log("Key:" + jl);  
				  		if(jl=="Package"){
				  			pack = json_res[jkey][jl];
				  		}
				  		if(jl=="Version"){
				  			version = json_res[jkey][jl];
				  		}
				  	  }     
				  }
				  var table = "";
				  var l=0;
				  for(var i=0; i<pack.length;i++){
					  l = i+1;
					  table += "<tr>"+
									"<td class='center'>"+l+"</td>"+
									"<td class='center'>"+pack[i]+"</td>"+
									"<td class='center'>"+version[i]+"</td>"+								
								"</tr>";
				  }
				  
				  $("#packlist").html(table);
			  }
			});
		
	}
	
	function FoundVar(e){
		if(e.keyCode == 13){
			var stemTxt=$("#r_query").val();
			//console.log("stemTxt:"+stemTxt);	
			var rLine = stemTxt.replace("\r","").split("\n");;
			//console.log("length:"+rLine.length);
			for(var i=0; i<rLine.length; i++){
				if(rLine[i].indexOf("<-") > 0){
					var rVar = rLine[i].split("<-");
					//console.log("rVar:"+rVar[0]+" fun:"+rVar[1]+" isfun:"+rVar[1].indexOf("function"));	
					if(rVar[1].indexOf("function") >=0){
						if(RKeyWords.indexOf(rVar[0]+"_fun")==-1){
							RKeyWords.push(rVar[0]+"_fun");
							//console.log("fun_:"+rVar[0]);
						}
					}else{ 
						if(RKeyWords.indexOf(rVar[0]+"_var")==-1){
							RKeyWords.push(rVar[0]+"_var");
							//console.log("var_:"+rVar[0]);
						}
					}
					
				}
			}
		}
		
	}

	function initEdits(){
	  var initEDit = getCookie("REdit");
	  var editCon = "${REdit!''}";
	  if(editCon.length > 0){
		   $("#r_query").val(unescape(editCon));
	   }
	  else if(initEDit.length >0){			    	   
		  $("#r_query").val(unescape(initEDit));
	    }
	    
	   // console.log("initEDit:"+initEDit);
	}
	function myInterval()
		{
	   var stemTxt=$("#r_query").val();
	   if(stemTxt.length > 1){
	   		setCookie("REdit", escape(stemTxt), 1);
	   }
	   //console.log("initEDit:"+stemTxt);
	}

	
	function validateForm(){
		$("#rcode").val($("#r_query").val());
		return true;
	}
	

	$(document).on("keyup", function(e) {
		
	    var code = e.which;
	    if (code == 40 || code == 38) {
	  
	    	var val = $(".textcomplete-item.active").html();
	    	
	    	 if(typeof  val != 'undefined' && val.indexOf("_var")==-1 && val.indexOf("_fun")==-1){
	             val = val.trim();
	             val = val.substr(3, val.length-7);
	         	//console.log(val);
	         	$("#cname").html(val);
	 	    	getKeyTip(val);
	     	}     
	    }
	       
	});
	
	function getKeyTip(o){
		var key = o.split(";")
		key = key[1];
		$.ajax({
			  url: "${search_url}?jsoncallback=?",
			  contentType: 'text/html;charset=utf-8',
			  
			  data:{"key":key},
			  success: function(result){
				  //console.log("success:"+result);
			  },
			  error: function(request, textStatus, errorThrown) {
			    //alert(textStatus);
			  },
			  complete: function(request, textStatus) { //for additional info
				  var option = request.responseText;
				  //option = option.replace(/[\r\n]/g, "");							  
				  
				 // console.log("success:"+option);
				  $("#tips").html(option);
			  }
			});
	}
	
	function ScriptR(){
		$.ajax({
			  url: "${script_url}?jsoncallback=?",
			  contentType: 'text/html;charset=utf-8',			  
			  data:{"query":$("#r_query").val()},
			  success: function(result){
				  console.log("success"+result);
			  },
			  error: function(request, textStatus, errorThrown) {
			    //alert(textStatus);
			  },
			  complete: function(request, textStatus) { //for additional info
				  var option = request.responseText;
				 // option = option.replace(/[\r\n]/g, "<br />");							  
				  
				  console.log("success:"+option);
				  
				 
				  var json_res = JSON.parse(option);
					
					
				  var node = new PrettyJSON.view.Node({
					  el:$('#json_result'),
					  data:json_res
				  });
					
				  node.expandAll();
				 /// $("#json_result").html(option);
			  }
			});
	}
	
	function SaveFile() {
		$("#saveImg").attr("class", "disabled btn btn-xs btn-app btn-primary");
		//var timestamp = Date.parse(new Date());
		
	
	     console.log("filePath:"+$("#attachment").prop('files'));
	     

		//checkFile(md5Name);
		
	}
	
	function ajaxLoog(o, dataName){
		var dataURL = myChart.getDataURL();
		var step = 1024*2;
		var len = Math.ceil(dataURL.length/step) ;
		if(o>=len) return;
		
		$("#loop_ico").attr("class","icon-spinner icon-spin orange bigger-125");

		var datasplit = dataURL.substr(o*step, step);
		$.ajax({
		  url: "${saveimg_url!''}?jsoncallback=?",
		  contentType: 'text/html;charset=utf-8',
		  //async: false,
		  data:{"data":datasplit,"n":o,"len":len,"name":dataName},
		  success: function(result){
			 // console.log("success:"+result);
		  },
		  error: function(request, textStatus, errorThrown) {
		    //alert(textStatus);
		  },
		  complete: function(request, textStatus) { //for additional info
			  var option = request.responseText;
			 // console.log("option:"+option);
			  $("#loop_name").html( Math.ceil(option/len*100) +"%");
			  if(parseInt(option)==len-1){					  
				CreateImg(dataName);
				$("#loop_ico").attr("class","icon-th-large");
				$("#loop_name").html( "保存图表");
			  }else{
				  ajaxLoog(o+1, dataName);
			  }
		  }
		});			
		
	}
	
	function checkFile(ImgName){
		$.ajax({
			  url: "${searchimg_url!''}?jsoncallback=?",
			  contentType: 'text/html;charset=utf-8',
			  //async: false,
			  data:{"ImgName":ImgName},
			  success: function(result){
				 // console.log("success:"+result);
			  },
			  error: function(request, textStatus, errorThrown) {
			    //alert(textStatus);
			  },
			  complete: function(request, textStatus) { //for additional info
				  var option = request.responseText;
				 // console.log("option:"+option);
				  if(parseInt(option)==1){						  
					  CreateImg(ImgName);				
				  }else{
					  ajaxLoog(0, ImgName);
				  }
			  }
			});		
	}
</script>  
 